## 上下文

当前 `FusionModel` 已支持 `USTC-TFC2016` 与 `CICAndMal2017` 的预处理和融合训练流程，但新增的 `MFCP` 数据尚未接入统一入口。变更目标是在不修改既有两套数据集行为的前提下，新增 `MFCP` 的数据预处理、训练与验证能力，并继续沿用现有输出约定（`dataset/` 与 `outputs/`）。同时，MFCP 首次读取后需要复用既有数据集的索引缓存逻辑，避免后续重复全量扫描。

关键约束：
- 仅在当前仓库实现，不改动外部仓库。
- 图像预处理必须保持 RGB 三通道。
- USTC 与 CIC 继续独立训练/验证，不引入交替喂数。
- 训练产物需保留日志、曲线、混淆矩阵与评估报告。

## 目标 / 非目标

**目标：**
- 为 MFCP 增加端到端预处理流程，输出与既有数据集一致的目录结构和文件格式。
- 复用既有索引逻辑，在 MFCP 首次读取后生成可复用索引，后续读取优先命中索引。
- 为 MFCP 增加独立训练/验证入口与配置，保证可生成一致的评估产物。
- 保持 USTC/CIC 的数据路径、命令习惯和输出结构不变。
- 在 README 中补充 MFCP 预处理、训练与验证命令。

**非目标：**
- 不改造模型主体结构（MobileViT、CharBERT、Attention）和损失函数策略。
- 不将 MFCP 与 USTC/CIC 做联合或交替训练。
- 不改变历史产物命名规则，不重构现有 USTC/CIC 实验记录。

## 决策

### 决策 1：采用“数据集注册 + 参数化入口”扩展 MFCP
通过在 `configs/` 和训练/预处理入口中新增 `mfcp` 数据集标识与映射，实现最小侵入扩展，而不是复制一套独立脚本。

备选方案：
- 方案 A：复制 USTC/CIC 脚本并硬编码 MFCP 路径。优点是快；缺点是后续维护成本高、分支逻辑重复。
- 方案 B（采用）：复用现有流程并通过配置驱动。优点是一致性强、回归风险可控。

### 决策 2：MFCP 输出严格复用现有目录契约
MFCP 预处理后必须生成：
- `dataset/mfcp/pcap_data/{Train,Test}/<class>/*.bin`
- `dataset/mfcp/image_data/{Train,Test}/<class>/*.png`

备选方案：
- 方案 A：为 MFCP 定义新目录层级。缺点是训练端需要额外分支，破坏统一性。
- 方案 B（采用）：沿用统一目录约定，训练代码无需新增特殊分支。

### 决策 3：图像处理保留 RGB 三通道并加校验
MFCP 图像处理不提供灰度选项，输出阶段对通道数进行校验（3 通道）并在日志记录异常样本统计。

备选方案：
- 方案 A：允许灰度作为可选分支。缺点是违背项目约束并造成输入分布不一致。
- 方案 B（采用）：统一 RGB，减少输入分布漂移。

### 决策 4：训练与评估产物保持统一命名与位置
MFCP 训练/验证产物继续写入 `outputs/`，包含：
- `outputs/logs/*.log`
- `outputs/confusion_matrix_*.png`
- `outputs/metrics_curve_*.png`
- `outputs/report_*.md`

并在命名中包含数据集标识（`mfcp`）以便区分实验。

备选方案：
- 方案 A：MFCP 单独输出到新根目录。缺点是破坏现有工具链读取路径。
- 方案 B（采用）：沿用 `outputs/` 结构并通过命名区分。

### 决策 5：复用既有数据集索引逻辑并在首次读取后落盘
MFCP 数据读取路径复用既有数据集的索引缓存机制。首次读取且索引不存在时执行全量扫描并写入索引文件；后续读取若索引有效则直接按索引加载样本列表；若检测到源数据变化则自动重建索引。

备选方案：
- 方案 A：每次都全量扫描目录。缺点是大规模数据下启动时间长，重复开销高。
- 方案 B（采用）：首次构建索引、后续复用并带失效重建。优点是兼顾性能与数据一致性。

### 决策 6：PCAP 解析采用“尾部截断容错 + 起始损坏失败”策略
针对 MFCP 等大文件场景，预处理读取 `pcap` 时若已成功解析部分包但在文件尾部遇到不完整记录（例如 `NeedData`），应保留已解析会话并继续后续流程；若文件从起始即无法解析，则仍视为损坏文件并按失败处理。

备选方案：
- 方案 A：一旦出现 `NeedData` 即整文件失败。缺点是会丢弃大部分有效数据，影响样本覆盖率。
- 方案 B（采用）：仅在“已有可解析数据 + 尾部截断”时容错继续。优点是最大化有效样本利用，同时保留对严重损坏文件的失败告警。

## 风险 / 权衡

- [风险] MFCP 原始标签与现有类别映射不一致，导致训练标签错配  
  → 缓解措施：在预处理阶段加入类别映射校验与样本计数汇总，训练前执行标签完整性检查。

- [风险] 新增数据集逻辑可能影响 USTC/CIC 默认路径解析  
  → 缓解措施：保持原默认配置不变，仅在显式选择 `mfcp` 时进入新增分支。

- [风险] RGB 图像生成开销增大，预处理耗时上升  
  → 缓解措施：增加增量处理策略（已存在产物可跳过）并输出阶段性进度日志。

- [风险] 文档命令与代码入口不一致  
  → 缓解措施：README 命令直接引用实际 CLI 参数，并在任务中加入文档验收项。

- [风险] 索引文件过期导致样本列表与源数据不一致  
  → 缓解措施：在读取时校验索引元信息（时间戳/数量/签名），失效则自动重建并记录日志。

- [风险] 对尾部截断容错可能掩盖源数据质量问题  
  → 缓解措施：保留显式 warning 日志并记录受影响文件路径、已解析包数和异常原因，便于后续数据治理。

## 迁移计划

1. 在 `configs/` 增加 MFCP 专用数据与训练配置，不修改 USTC/CIC 现有配置默认值。  
2. 在 `src/pipeline/` 增加 MFCP 数据读取、切分、`.bin` 与 RGB `.png` 生成逻辑，并保持输出目录契约一致。  
3. 在 `src/pipeline/` 接入索引缓存：首次读取写索引、后续读取命中索引、索引失效自动重建。  
4. 在 `src/fusion/` 扩展数据集选择逻辑与训练入口，支持 `mfcp` 独立训练/验证。  
5. 对 MFCP 运行一次预处理与训练验证流程，确认日志、曲线、混淆矩阵、报告均生成。  
6. 对 MFCP 连续运行两次读取流程，确认第二次命中索引且跳过全量扫描。  
7. 使用尾部残缺的 `pcap` 做回归，确认预处理可保留前序可解析会话并产出样本。  
8. 更新 `README.md` 的 MFCP 命令示例并执行命令可用性检查。  

回滚策略：
- 若 MFCP 分支引入回归，保留新增配置与入口开关，默认路径继续走 USTC/CIC 旧行为；必要时可临时关闭 `mfcp` 入口而不影响现有实验。

## 未决问题

- MFCP 是否提供官方 `Train/Test` 划分，或需要在预处理中按比例自动切分。  
- MFCP 类别清单与类名规范（是否已固定、是否需要别名映射）。  
- MFCP 单样本序列长度与图像尺寸是否沿用现有默认值，或需要单独参数化。  
- 索引有效性判定策略优先采用时间戳、文件计数还是内容签名。  
