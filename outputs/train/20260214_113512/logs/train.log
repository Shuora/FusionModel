2026-02-14 11:35:12,380 - INFO - train_attention_stacking - 运行 ID: 20260214_113512
2026-02-14 11:35:12,381 - INFO - train_attention_stacking - 训练设备: cuda:0
2026-02-14 11:35:12,382 - INFO - train_common - 加载数据集: USTC_10
2026-02-14 11:35:12,382 - INFO - train_common - 训练目录 image=C:\Repositories\Traffic\FusionModel\dataset\USTC_10\image_data\Train pcap=C:\Repositories\Traffic\FusionModel\dataset\USTC_10\pcap_data\Train
2026-02-14 11:35:12,382 - INFO - train_common - 验证目录 image=C:\Repositories\Traffic\FusionModel\dataset\USTC_10\image_data\Test pcap=C:\Repositories\Traffic\FusionModel\dataset\USTC_10\pcap_data\Test
2026-02-14 11:35:12,576 - INFO - train_common - DataLoader 参数: batch_size=64 num_workers=4 pin_memory=True
2026-02-14 11:35:12,576 - INFO - train_common - 训练样本=52375 验证样本=19396 类别数=10
2026-02-14 11:35:12,577 - INFO - train_common - 训练集类别分布: Cridex:8196, Geodo:4977, Htbot:4705, Miuref:3967, Neris:5196, Nsis-ay:4819, Shifu:7655, Tinba:6803, Virut:2584, Zeus:3473
2026-02-14 11:35:12,577 - INFO - train_common - 验证集类别分布: Cridex:1642, Geodo:1712, Htbot:1246, Miuref:984, Neris:3232, Nsis-ay:1214, Shifu:1920, Tinba:1700, Virut:3555, Zeus:2191
2026-02-14 11:35:12,577 - INFO - train_common - 启用采样策略: weighted_sampler_loss
2026-02-14 11:35:12,577 - INFO - train_attention_stacking - 训练参数: {"dataset_root": "dataset/USTC_10", "dataset_name": "", "train_profile": "ustc_strict_base", "batch_size": 64, "image_size": 28, "char_seq_len": 786, "epochs": 32, "lr": 0.001, "weight_decay": 0.0001, "label_smoothing": 0.03, "patience": 8, "early_stop_metric": "val_f1", "optimizer": "adamw", "lr_scheduler": "reduce", "lr_patience": 2, "lr_factor": 0.5, "min_lr": 1e-06, "grad_clip_norm": 1.0, "class_balance": "weighted_sampler_loss", "loss_type": "ce", "focal_gamma": 2.0, "attention_dim": 256, "dropout": 0.3, "stage1_epochs": 10, "stage2_lr_scale": 0.25, "freeze_charbert_layers": 1, "use_pretrained_mobilevit": true, "mobilevit_pretrained_dir": "model/mobilevit-small", "mobilevit_pretrained_input_size": 224, "use_pretrained_charbert": false, "charbert_pretrained_path": "", "xgb_estimators": 300, "xgb_max_depth": 6, "xgb_lr": 0.05, "stacking_subsample": 1.0, "num_workers": 4, "pin_memory": false, "device": "auto", "seed": 42, "no_amp": false, "ablation": "none", "no_index_cache": false, "rebuild_index_cache": false, "output_dir": "outputs/train", "run_name": ""}
2026-02-14 11:35:12,578 - INFO - train_attention_stacking - 数据集=USTC_10 类别数=10 训练样本=52375 验证样本=19396
2026-02-14 11:35:15,178 - INFO - models_charbert_mobilevit - 已加载预训练 MobileViT: C:\Repositories\Traffic\FusionModel\model\mobilevit-small
2026-02-14 11:35:15,419 - INFO - train_attention_stacking - 模型参数量: total=5668670 trainable=5668670
2026-02-14 11:35:15,421 - INFO - train_attention_stacking - Stage1 冻结训练: epochs=10 冻结CharBERT前层=1 trainable_params=499614
2026-02-14 11:35:15,421 - INFO - train_common - [stage1] 开始训练: epochs=10 start_epoch=1 patience=8 early_stop_metric=val_f1 use_amp=True scheduler=reduce grad_clip_norm=1.0
2026-02-14 11:37:36,754 - INFO - train_common - 保存最佳模型: C:\Repositories\Traffic\FusionModel\outputs\train\20260214_113512\checkpoints\best.pt (epoch=1, val_f1=0.722749)
2026-02-14 11:37:36,755 - INFO - train_common - [stage1] Epoch 1 结果: 训练 Loss=0.438029 Acc=0.9175 F1=0.9155 | 验证 Loss=1.777518 Acc=0.6480 F1=0.7227 | best_val_f1=0.722749 wait=0/8 耗时=141.2s
2026-02-14 11:37:36,755 - INFO - train_common - [stage1] 当前学习率: 0.00100000
2026-02-14 11:39:33,951 - INFO - train_common - 保存最佳模型: C:\Repositories\Traffic\FusionModel\outputs\train\20260214_113512\checkpoints\best.pt (epoch=2, val_f1=0.723057)
2026-02-14 11:39:33,951 - INFO - train_common - [stage1] Epoch 2 结果: 训练 Loss=0.295786 Acc=0.9649 F1=0.9632 | 验证 Loss=1.968291 Acc=0.6529 F1=0.7231 | best_val_f1=0.723057 wait=0/8 耗时=117.1s
2026-02-14 11:39:33,951 - INFO - train_common - [stage1] 当前学习率: 0.00100000
2026-02-14 11:41:30,779 - INFO - train_common - [stage1] Epoch 3 结果: 训练 Loss=0.280243 Acc=0.9698 F1=0.9684 | 验证 Loss=2.090260 Acc=0.6528 F1=0.7090 | best_val_f1=0.723057 wait=1/8 耗时=116.7s
2026-02-14 11:41:30,780 - INFO - train_common - [stage1] 当前学习率: 0.00100000
2026-02-14 11:43:28,185 - INFO - train_common - [stage1] Epoch 4 结果: 训练 Loss=0.264723 Acc=0.9756 F1=0.9743 | 验证 Loss=2.120904 Acc=0.6482 F1=0.7125 | best_val_f1=0.723057 wait=2/8 耗时=117.4s
2026-02-14 11:43:28,186 - INFO - train_common - [stage1] 当前学习率: 0.00100000
2026-02-14 11:45:25,012 - INFO - train_common - [stage1] Epoch 5 结果: 训练 Loss=0.260221 Acc=0.9762 F1=0.9749 | 验证 Loss=1.807349 Acc=0.6494 F1=0.7197 | best_val_f1=0.723057 wait=3/8 耗时=116.8s
2026-02-14 11:45:25,012 - INFO - train_common - [stage1] 当前学习率: 0.00050000
2026-02-14 11:47:21,931 - INFO - train_common - [stage1] Epoch 6 结果: 训练 Loss=0.238920 Acc=0.9822 F1=0.9814 | 验证 Loss=1.658262 Acc=0.6519 F1=0.6976 | best_val_f1=0.723057 wait=4/8 耗时=116.9s
2026-02-14 11:47:21,932 - INFO - train_common - [stage1] 当前学习率: 0.00050000
2026-02-14 11:49:18,921 - INFO - train_common - [stage1] Epoch 7 结果: 训练 Loss=0.234133 Acc=0.9842 F1=0.9834 | 验证 Loss=1.773850 Acc=0.6456 F1=0.6951 | best_val_f1=0.723057 wait=5/8 耗时=116.9s
2026-02-14 11:49:18,921 - INFO - train_common - [stage1] 当前学习率: 0.00050000
2026-02-14 11:51:15,660 - INFO - train_common - [stage1] Epoch 8 结果: 训练 Loss=0.231769 Acc=0.9847 F1=0.9838 | 验证 Loss=1.822082 Acc=0.6464 F1=0.6982 | best_val_f1=0.723057 wait=6/8 耗时=116.7s
2026-02-14 11:51:15,662 - INFO - train_common - [stage1] 当前学习率: 0.00025000
2026-02-14 11:53:12,644 - INFO - train_common - [stage1] Epoch 9 结果: 训练 Loss=0.221871 Acc=0.9879 F1=0.9872 | 验证 Loss=1.965339 Acc=0.6421 F1=0.6922 | best_val_f1=0.723057 wait=7/8 耗时=116.9s
2026-02-14 11:53:12,644 - INFO - train_common - [stage1] 当前学习率: 0.00025000
2026-02-14 11:55:09,595 - INFO - train_common - [stage1] Epoch 10 结果: 训练 Loss=0.221130 Acc=0.9880 F1=0.9875 | 验证 Loss=1.805196 Acc=0.6460 F1=0.6974 | best_val_f1=0.723057 wait=8/8 耗时=116.9s
2026-02-14 11:55:09,596 - INFO - train_common - [stage1] 当前学习率: 0.00025000
2026-02-14 11:55:09,596 - INFO - train_common - [stage1] 触发早停: epoch=10 (best_epoch=2)
2026-02-14 11:55:09,617 - INFO - train_attention_stacking - stage2 训练: epochs=22 lr=0.000250 trainable_params=5668670
2026-02-14 11:55:09,618 - INFO - train_common - [stage2] 开始训练: epochs=22 start_epoch=11 patience=8 early_stop_metric=val_f1 use_amp=True scheduler=reduce grad_clip_norm=1.0
2026-02-14 11:59:16,806 - INFO - train_common - 保存最佳模型: C:\Repositories\Traffic\FusionModel\outputs\train\20260214_113512\checkpoints\best.pt (epoch=11, val_f1=0.711502)
2026-02-14 11:59:16,806 - INFO - train_common - [stage2] Epoch 11 结果: 训练 Loss=0.265501 Acc=0.9760 F1=0.9747 | 验证 Loss=1.636957 Acc=0.6584 F1=0.7115 | best_val_f1=0.711502 wait=0/8 耗时=246.9s
2026-02-14 11:59:16,806 - INFO - train_common - [stage2] 当前学习率: 0.00025000
2026-02-14 12:03:17,100 - INFO - train_common - [stage2] Epoch 12 结果: 训练 Loss=0.237528 Acc=0.9844 F1=0.9837 | 验证 Loss=1.843265 Acc=0.6531 F1=0.6942 | best_val_f1=0.711502 wait=1/8 耗时=240.2s
2026-02-14 12:03:17,100 - INFO - train_common - [stage2] 当前学习率: 0.00025000
2026-02-14 12:07:17,557 - INFO - train_common - 保存最佳模型: C:\Repositories\Traffic\FusionModel\outputs\train\20260214_113512\checkpoints\best.pt (epoch=13, val_f1=0.733683)
2026-02-14 12:07:17,558 - INFO - train_common - [stage2] Epoch 13 结果: 训练 Loss=0.225739 Acc=0.9880 F1=0.9873 | 验证 Loss=1.400648 Acc=0.6790 F1=0.7337 | best_val_f1=0.733683 wait=0/8 耗时=240.2s
2026-02-14 12:07:17,558 - INFO - train_common - [stage2] 当前学习率: 0.00025000
2026-02-14 12:11:17,788 - INFO - train_common - [stage2] Epoch 14 结果: 训练 Loss=0.219854 Acc=0.9898 F1=0.9891 | 验证 Loss=1.901511 Acc=0.6439 F1=0.6879 | best_val_f1=0.733683 wait=1/8 耗时=240.1s
2026-02-14 12:11:17,788 - INFO - train_common - [stage2] 当前学习率: 0.00025000
2026-02-14 12:15:18,261 - INFO - train_common - [stage2] Epoch 15 结果: 训练 Loss=0.214813 Acc=0.9916 F1=0.9911 | 验证 Loss=1.814965 Acc=0.6553 F1=0.7163 | best_val_f1=0.733683 wait=2/8 耗时=240.3s
2026-02-14 12:15:18,261 - INFO - train_common - [stage2] 当前学习率: 0.00025000
2026-02-14 12:19:18,593 - INFO - train_common - [stage2] Epoch 16 结果: 训练 Loss=0.211693 Acc=0.9928 F1=0.9923 | 验证 Loss=1.539734 Acc=0.6732 F1=0.7133 | best_val_f1=0.733683 wait=3/8 耗时=240.2s
2026-02-14 12:19:18,593 - INFO - train_common - [stage2] 当前学习率: 0.00012500
2026-02-14 12:23:19,020 - INFO - train_common - [stage2] Epoch 17 结果: 训练 Loss=0.202037 Acc=0.9957 F1=0.9954 | 验证 Loss=1.725826 Acc=0.6612 F1=0.7058 | best_val_f1=0.733683 wait=4/8 耗时=240.3s
2026-02-14 12:23:19,021 - INFO - train_common - [stage2] 当前学习率: 0.00012500
2026-02-14 12:27:19,411 - INFO - train_common - [stage2] Epoch 18 结果: 训练 Loss=0.201709 Acc=0.9954 F1=0.9952 | 验证 Loss=1.700164 Acc=0.6673 F1=0.7077 | best_val_f1=0.733683 wait=5/8 耗时=240.3s
2026-02-14 12:27:19,411 - INFO - train_common - [stage2] 当前学习率: 0.00012500
2026-02-14 12:31:19,618 - INFO - train_common - [stage2] Epoch 19 结果: 训练 Loss=0.200540 Acc=0.9957 F1=0.9955 | 验证 Loss=1.707958 Acc=0.6649 F1=0.7048 | best_val_f1=0.733683 wait=6/8 耗时=240.0s
2026-02-14 12:31:19,618 - INFO - train_common - [stage2] 当前学习率: 0.00006250
2026-02-14 12:35:20,046 - INFO - train_common - [stage2] Epoch 20 结果: 训练 Loss=0.197760 Acc=0.9964 F1=0.9963 | 验证 Loss=1.750551 Acc=0.6625 F1=0.7012 | best_val_f1=0.733683 wait=7/8 耗时=240.3s
2026-02-14 12:35:20,046 - INFO - train_common - [stage2] 当前学习率: 0.00006250
2026-02-14 12:39:20,229 - INFO - train_common - [stage2] Epoch 21 结果: 训练 Loss=0.196053 Acc=0.9974 F1=0.9973 | 验证 Loss=1.773524 Acc=0.6612 F1=0.7013 | best_val_f1=0.733683 wait=8/8 耗时=240.1s
2026-02-14 12:39:20,229 - INFO - train_common - [stage2] 当前学习率: 0.00006250
2026-02-14 12:39:20,229 - INFO - train_common - [stage2] 触发早停: epoch=21 (best_epoch=13)
2026-02-14 12:39:20,254 - INFO - train_common - 已保存训练曲线数据: C:\Repositories\Traffic\FusionModel\outputs\train\20260214_113512\metrics\epoch_metrics.csv
2026-02-14 12:39:20,974 - INFO - train_common - 已保存训练曲线图: C:\Repositories\Traffic\FusionModel\outputs\train\20260214_113512\figures
2026-02-14 12:39:45,499 - INFO - train_common - 已保存分类报告: C:\Repositories\Traffic\FusionModel\outputs\train\20260214_113512\reports\classification_report.txt
2026-02-14 12:39:45,733 - INFO - train_common - 已保存混淆矩阵: C:\Repositories\Traffic\FusionModel\outputs\train\20260214_113512\reports\confusion_matrix.png
2026-02-14 12:39:45,746 - INFO - train_attention_stacking - [base] 分类报告:
precision    recall  f1-score   support

      Cridex     0.9994    0.9957    0.9976      1642
       Geodo     1.0000    0.6104    0.7581      1712
       Htbot     0.2231    0.9912    0.3642      1246
      Miuref     0.9989    0.9482    0.9729       984
       Neris     0.6590    0.1962    0.3023      3232
     Nsis-ay     0.5186    1.0000    0.6830      1214
       Shifu     0.9856    0.9964    0.9909      1920
       Tinba     0.9872    1.0000    0.9936      1700
       Virut     0.6767    0.1902    0.2969      3555
        Zeus     0.9583    0.9973    0.9774      2191

    accuracy                         0.6790     19396
   macro avg     0.8007    0.7925    0.7337     19396
weighted avg     0.7965    0.6790    0.6672     19396
2026-02-14 12:39:45,747 - INFO - train_attention_stacking - [base] 混淆矩阵:
[[1635    0    6    0    0    0    0    1    0    0]
 [   0 1045  597    0   68    0    0    0    0    2]
 [   0    0 1235    0    3    0    5    0    0    3]
 [   0    0   43  933    1    0    0    1    0    6]
 [   1    0 1609    0  634  572   12   17  323   64]
 [   0    0    0    0    0 1214    0    0    0    0]
 [   0    0    6    0    0    0 1913    0    0    1]
 [   0    0    0    0    0    0    0 1700    0    0]
 [   0    0 2034    1  256  555   11    3  676   19]
 [   0    0    6    0    0    0    0    0    0 2185]]
2026-02-14 12:39:45,747 - INFO - train_common - 已保存 Markdown 报告: C:\Repositories\Traffic\FusionModel\outputs\train\20260214_113512\reports\report_attention_base.md
